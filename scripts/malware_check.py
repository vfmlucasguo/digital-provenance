#!/usr/bin/env python3
"""
æ¶æ„è½¯ä»¶åŒ…æ£€æµ‹è„šæœ¬
æ£€æŸ¥SBOMä¸­æ˜¯å¦åŒ…å«å·²çŸ¥çš„æ¶æ„æˆ–å¯ç–‘è½¯ä»¶åŒ…
"""

import json
import sys
import requests
from typing import Dict, List, Set

# å·²çŸ¥æ¶æ„åŒ…åˆ—è¡¨ (ç¤ºä¾‹ï¼Œå®é™…åº”ä»å¨èƒæƒ…æŠ¥æºè·å–)
KNOWN_MALICIOUS_PACKAGES = {
    'npm': {
        'event-stream': ['3.3.6'],  # å†å²æ¶æ„ç‰ˆæœ¬
        'eslint-scope': ['3.7.2'],
        'getcookies': ['*'],
        'http-fetch': ['*'],
        'node-sqlite': ['*'],
    }
}

# å¯ç–‘åŒ…åæ¨¡å¼
SUSPICIOUS_PATTERNS = [
    'discord-token',
    'password-stealer',
    'keylogger',
    'bitcoin-miner',
    'crypto-miner',
    'remote-access',
    'backdoor',
]

def load_sbom(file_path: str) -> Dict:
    """åŠ è½½SBOMæ–‡ä»¶"""
    try:
        with open(file_path, 'r') as f:
            return json.load(f)
    except FileNotFoundError:
        print(f"âŒ é”™è¯¯: æ‰¾ä¸åˆ°æ–‡ä»¶ {file_path}")
        sys.exit(1)
    except json.JSONDecodeError:
        print(f"âŒ é”™è¯¯: æ— æ•ˆçš„JSONæ–‡ä»¶ {file_path}")
        sys.exit(1)

def check_malicious_packages(components: List[Dict]) -> List[Dict]:
    """æ£€æŸ¥æ¶æ„è½¯ä»¶åŒ…"""
    threats = []

    for component in components:
        name = component.get('name', '').lower()
        version = component.get('version', '')
        comp_type = component.get('type', '')

        # æ£€æŸ¥å·²çŸ¥æ¶æ„åŒ…
        if comp_type in KNOWN_MALICIOUS_PACKAGES:
            malicious_versions = KNOWN_MALICIOUS_PACKAGES[comp_type].get(name, [])
            if '*' in malicious_versions or version in malicious_versions:
                threats.append({
                    'type': 'known_malicious',
                    'severity': 'CRITICAL',
                    'component': name,
                    'version': version,
                    'description': f'å·²çŸ¥æ¶æ„åŒ…: {name}@{version}'
                })

        # æ£€æŸ¥å¯ç–‘åŒ…å
        for pattern in SUSPICIOUS_PATTERNS:
            if pattern in name:
                threats.append({
                    'type': 'suspicious_name',
                    'severity': 'HIGH',
                    'component': name,
                    'version': version,
                    'description': f'å¯ç–‘åŒ…ååŒ…å«: {pattern}'
                })

    return threats

def check_typosquatting(components: List[Dict]) -> List[Dict]:
    """æ£€æŸ¥åŸŸåæŠ¢æ³¨æ”»å‡» (typosquatting)"""
    threats = []

    # å¸¸è§çš„æ­£ç‰ˆåŒ…å
    popular_packages = {
        'react', 'angular', 'vue', 'lodash', 'express', 'axios',
        'moment', 'jquery', 'bootstrap', 'webpack', 'babel'
    }

    for component in components:
        name = component.get('name', '').lower()

        for popular in popular_packages:
            # ç®€å•çš„ç¼–è¾‘è·ç¦»æ£€æŸ¥
            if len(name) == len(popular) and sum(c1 != c2 for c1, c2 in zip(name, popular)) == 1:
                if name != popular:  # ä¸æ˜¯æ­£ç‰ˆåŒ…
                    threats.append({
                        'type': 'typosquatting',
                        'severity': 'MEDIUM',
                        'component': name,
                        'version': component.get('version', ''),
                        'description': f'å¯èƒ½çš„åŸŸåæŠ¢æ³¨æ”»å‡»ï¼Œç–‘ä¼¼æ¨¡ä»¿: {popular}'
                    })

    return threats

def generate_report(threats: List[Dict]) -> str:
    """ç”Ÿæˆå¨èƒæŠ¥å‘Š"""
    if not threats:
        return "âœ… æœªå‘ç°æ¶æ„è½¯ä»¶åŒ…å¨èƒ"

    report = f"âš ï¸ å‘ç° {len(threats)} ä¸ªæ½œåœ¨å¨èƒ:\n\n"

    # æŒ‰ä¸¥é‡ç¨‹åº¦åˆ†ç»„
    by_severity = {}
    for threat in threats:
        severity = threat['severity']
        if severity not in by_severity:
            by_severity[severity] = []
        by_severity[severity].append(threat)

    for severity in ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW']:
        if severity in by_severity:
            report += f"## {severity} çº§å¨èƒ ({len(by_severity[severity])}ä¸ª)\n\n"
            for threat in by_severity[severity]:
                report += f"- **{threat['component']}@{threat['version']}**\n"
                report += f"  - ç±»å‹: {threat['type']}\n"
                report += f"  - æè¿°: {threat['description']}\n\n"

    return report

def main():
    if len(sys.argv) != 2:
        print("ç”¨æ³•: python3 malware_check.py <sbom_file.json>")
        sys.exit(1)

    sbom_file = sys.argv[1]
    print(f"ğŸ” æ­£åœ¨æ‰«ææ¶æ„è½¯ä»¶åŒ…: {sbom_file}")

    # åŠ è½½SBOM
    sbom = load_sbom(sbom_file)
    components = sbom.get('components', [])

    print(f"ğŸ“¦ æ‰«æ {len(components)} ä¸ªç»„ä»¶...")

    # æ‰§è¡Œæ£€æŸ¥
    threats = []
    threats.extend(check_malicious_packages(components))
    threats.extend(check_typosquatting(components))

    # ç”ŸæˆæŠ¥å‘Š
    report = generate_report(threats)
    print(report)

    # å¦‚æœå‘ç°ä¸¥é‡å¨èƒï¼Œè¿”å›é”™è¯¯ç 
    critical_threats = [t for t in threats if t['severity'] == 'CRITICAL']
    if critical_threats:
        print(f"\nâŒ å‘ç° {len(critical_threats)} ä¸ªä¸¥é‡å¨èƒï¼Œæ„å»ºå¤±è´¥")
        sys.exit(1)

    high_threats = [t for t in threats if t['severity'] == 'HIGH']
    if high_threats:
        print(f"\nâš ï¸ å‘ç° {len(high_threats)} ä¸ªé«˜å±å¨èƒï¼Œè¯·å®¡æŸ¥")

    print("âœ… æ¶æ„è½¯ä»¶åŒ…æ‰«æå®Œæˆ")

if __name__ == "__main__":
    main()