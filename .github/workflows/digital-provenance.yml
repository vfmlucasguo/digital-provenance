name: AI Digital Provenance (Simplified & Automated)

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**' # ä»…åœ¨æºç å˜åŠ¨æ—¶è§¦å‘ï¼ŒèŠ‚çœèµ„æº
  pull_request:
    branches: [ main ]

jobs:
  ai-provenance:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # 1. å®‰è£…æ ¸å¿ƒå·¥å…· (ç§»é™¤ Cosign)
    - name: Install Syft (SBOM Generator)
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
        echo "ğŸ“¦ Syft installed for SBOM generation"

    # 2. AIæ•°å­—æº¯æºæ ¸å¿ƒæµç¨‹
    - name: Generate Base SBOM
      run: |
        echo "ğŸ“¦ Generating Software Bill of Materials..."
        syft . -o cyclonedx-json > base-sbom.json
        COMPONENT_COUNT=$(jq '.components | length' base-sbom.json)
        echo "âœ… SBOM generated with $COMPONENT_COUNT components"
        echo "COMPONENT_COUNT=$COMPONENT_COUNT" >> $GITHUB_ENV

    - name: AI Code Detection & Statistics
      run: |
        echo "ğŸ¤– Running full-range AI code detection in src/..."
        python3 scripts/process_aibom.py

        # åŒ¹é…è„šæœ¬ç”Ÿæˆçš„æœ€æ–°ç»Ÿè®¡å­—æ®µ
        AI_LINES=$(jq -r '.metadata.properties[] | select(.name=="stats:ai_total_lines") | .value' aibom-final.json)
        AI_PCT=$(jq -r '.metadata.properties[] | select(.name=="stats:ai_percentage") | .value' aibom-final.json)
        TOTAL_LINES=$(jq -r '.metadata.properties[] | select(.name=="stats:src_total_lines") | .value' aibom-final.json)

        echo "ğŸ” AI Statistics Results:"
        echo "  - Total Lines in src/: $TOTAL_LINES"
        echo "  - AI Generated Lines: $AI_LINES"
        echo "  - AI Percentage: $AI_PCT"

        echo "AI_LINES=$AI_LINES" >> $GITHUB_ENV
        echo "AI_PCT=$AI_PCT" >> $GITHUB_ENV
        echo "TOTAL_LINES=$TOTAL_LINES" >> $GITHUB_ENV

    # 3. ä¿å­˜ AI æº¯æºç»“æœ (ä»…ä¿ç•™æ ¸å¿ƒ AIBOM)
    - name: Upload AI Provenance Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ai-provenance-report-${{ github.sha }}
        path: aibom-final.json
        retention-days: 30

    # 4. ç”Ÿæˆ AI æº¯æºæ‘˜è¦ (å±•ç¤ºåœ¨ GitHub Action ç•Œé¢)
    - name: Generate AI Provenance Summary
      run: |
        echo "## ğŸ¤– AIæ•°å­—æº¯æºæŠ¥å‘Š (å…¨åŸŸç»Ÿè®¡)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š src/ ç›®å½•é‡åŒ–æŒ‡æ ‡" >> $GITHUB_STEP_SUMMARY
        echo "- **é¡¹ç›®æ€»è¡Œæ•°**: $TOTAL_LINES" >> $GITHUB_STEP_SUMMARY
        echo "- **AI ç”Ÿæˆè¡Œæ•°**: $AI_LINES" >> $GITHUB_STEP_SUMMARY
        echo "- **AI ä»£ç å æ¯”**: $AI_PCT" >> $GITHUB_STEP_SUMMARY
        echo "- **ç»„ä»¶æ€»æ•° (SBOM)**: $COMPONENT_COUNT" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "$AI_LINES" -ne "0" ]; then
          echo "âš ï¸ æ£€æµ‹åˆ°AIç”Ÿæˆçš„ä»£ç ï¼Œå·²åœ¨ AIBOM ä¸­è‡ªåŠ¨æ ‡è®°" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… æœªæ£€æµ‹åˆ° AI æ ‡æ³¨çš„ä»£ç " >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*ğŸ¯ AIæ•°å­—æº¯æºç³»ç»Ÿ - ç¡®ä¿ä»£ç é€æ˜åº¦å’Œå¯è¿½æº¯æ€§*" >> $GITHUB_STEP_SUMMARY

    # 5. PR ä¸­çš„ AI å˜æ›´åˆ†æ (ä»… PR è§¦å‘)
    - name: Comment PR with AI Analysis
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const aiPct = process.env.AI_PCT;
          const aiLines = process.env.AI_LINES;
          const body = `## ğŸ¤– AI ä»£ç é€æ˜åº¦åˆ†æ\n\næœ¬æ¬¡å˜æ›´æ£€æµ‹åˆ° AI ä»£ç æ¸—é€ç‡ä¸º **${aiPct}** (${aiLines} è¡Œ)ã€‚\n\n---\n*ç”± AI æ•°å­—æº¯æºç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ*`;
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });