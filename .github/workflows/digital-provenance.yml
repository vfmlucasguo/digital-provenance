name: AI Digital Provenance (Full Repository & Simplified)

on:
  push:
    branches: [ main, develop ]
    # ç§»é™¤äº†ç‰¹å®šè·¯å¾„è¿‡æ»¤ï¼Œç°åœ¨ç›‘å¬é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å˜åŠ¨
    paths:
      - '**'
  pull_request:
    branches: [ main ]

jobs:
  ai-provenance:
    runs-on: ubuntu-latest

    steps:
    # 1. åŸºç¡€ç¯å¢ƒè®¾ç½®
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # 2. å®‰è£…æ ¸å¿ƒå·¥å…· (å·²ç§»é™¤ Cosign å®‰è£…æ­¥éª¤)
    - name: Install Syft (SBOM Generator)
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
        echo "ğŸ“¦ Syft installed for SBOM generation"

    # 3. AI æ•°å­—æº¯æºæ ¸å¿ƒæµç¨‹
    - name: Generate Base SBOM
      run: |
        echo "ğŸ“¦ Generating Software Bill of Materials..."
        # ä½¿ç”¨ Syft æ‰«æé¡¹ç›®å¹¶ç”ŸæˆåŸºç¡€ JSON æ¸…å•
        syft . -o cyclonedx-json > base-sbom.json
        COMPONENT_COUNT=$(jq '.components | length' base-sbom.json)
        echo "âœ… SBOM generated with $COMPONENT_COUNT components"
        echo "COMPONENT_COUNT=$COMPONENT_COUNT" >> $GITHUB_ENV

    - name: AI Code Detection & Full Range Statistics
      env:
        BASE_REF: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || 'HEAD~1' }}
      run: |
        echo "ğŸ¤– Running AI code detection and statistics in src/..."
        python3 scripts/process_aibom.py --commit --base "$BASE_REF"

        AI_LINES=$(jq -r '.metadata.properties[] | select(.name=="stats:ai_total_lines") | .value' aibom-final.json)
        AI_PCT=$(jq -r '.metadata.properties[] | select(.name=="stats:ai_percentage") | .value' aibom-final.json)
        TOTAL_LINES=$(jq -r '.metadata.properties[] | select(.name=="stats:src_total_lines") | .value' aibom-final.json)
        COMMIT_AI=$(jq -r '.metadata.properties[] | select(.name=="stats:commit:ai_lines") | .value // "0"' aibom-final.json)
        COMMIT_ADDED=$(jq -r '.metadata.properties[] | select(.name=="stats:commit:total_added") | .value // "0"' aibom-final.json)
        COMMIT_PCT=$(jq -r '.metadata.properties[] | select(.name=="stats:commit:ai_percentage") | .value // "0"' aibom-final.json)

        echo "ğŸ” é¡¹ç›®ç´¯è®¡: $TOTAL_LINES è¡Œ | AI $AI_LINES è¡Œ ($AI_PCT)"
        echo "ğŸ” å½“å‰æäº¤: æ–°å¢ $COMMIT_ADDED è¡Œ | AI $COMMIT_AI è¡Œ ($COMMIT_PCT)"

        echo "AI_LINES=$AI_LINES" >> $GITHUB_ENV
        echo "AI_PCT=$AI_PCT" >> $GITHUB_ENV
        echo "TOTAL_LINES=$TOTAL_LINES" >> $GITHUB_ENV
        echo "COMMIT_AI=$COMMIT_AI" >> $GITHUB_ENV
        echo "COMMIT_ADDED=$COMMIT_ADDED" >> $GITHUB_ENV
        echo "COMMIT_PCT=$COMMIT_PCT" >> $GITHUB_ENV

    # 4. ä¿å­˜ AI æº¯æºç»“æœ (ä»…ä¿ç•™æ ¸å¿ƒ AIBOMï¼Œç§»é™¤ç­¾åæ–‡ä»¶)
    - name: Upload AI Provenance Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ai-provenance-report-${{ github.sha }}
        path: aibom-final.json
        retention-days: 30

    # 5. åœ¨ GitHub Action ç•Œé¢ç”Ÿæˆå¯è§†åŒ–æ‘˜è¦
    - name: Generate AI Provenance Summary
      run: |
        echo "## ğŸ¤– AI æ•°å­—æº¯æºæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š é¡¹ç›®ç´¯è®¡ (src/ å…¨é‡)" >> $GITHUB_STEP_SUMMARY
        echo "- **æ€»è¡Œæ•°**: $TOTAL_LINES | **AI è¡Œæ•°**: $AI_LINES | **æ¸—é€ç‡**: $AI_PCT" >> $GITHUB_STEP_SUMMARY
        echo "- **ä¾èµ–ç»„ä»¶**: $COMPONENT_COUNT" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š å½“å‰æäº¤ (diff æ–°å¢)" >> $GITHUB_STEP_SUMMARY
        echo "- **æœ¬ commit æ–°å¢**: $COMMIT_ADDED è¡Œ | **AI éƒ¨åˆ†**: $COMMIT_AI è¡Œ | **å æ¯”**: $COMMIT_PCT" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "$AI_LINES" != "0" ] || [ "$COMMIT_AI" != "0" ]; then
          echo "âš ï¸ æ£€æµ‹åˆ° AI ç”Ÿæˆä»£ç ï¼Œå·²æ ‡è®°äº aibom-final.json" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… æœªæ£€æµ‹åˆ° AI æ ‡æ³¨ä»£ç " >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*ğŸ¯ AI æ•°å­—æº¯æº - ä»£ç é€æ˜åº¦ä¸å¯è¿½æº¯æ€§*" >> $GITHUB_STEP_SUMMARY

    # 6. é’ˆå¯¹ Pull Request çš„ AI å˜æ›´åˆ†æ
    - name: Comment PR with AI Analysis
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const aiPct = process.env.AI_PCT || '0';
          const aiLines = process.env.AI_LINES || '0';
          const commitAi = process.env.COMMIT_AI || '0';
          const commitAdded = process.env.COMMIT_ADDED || '0';
          const commitPct = process.env.COMMIT_PCT || '0';
          const sep = [0x2D, 0x2D, 0x2D].map(c => String.fromCharCode(c)).join('');
          const body = [
            '## ğŸ¤– AI ä»£ç é€æ˜åº¦åˆ†æ',
            '',
            '**æœ¬ PR å˜æ›´**: æ–°å¢ ' + commitAdded + ' è¡Œï¼Œå…¶ä¸­ AI ç”Ÿæˆ **' + commitAi + '** è¡Œ (' + commitPct + ')',
            '**é¡¹ç›®ç´¯è®¡**: å…± ' + aiLines + ' è¡Œ AI ä»£ç ï¼Œæ¸—é€ç‡ **' + aiPct + '**',
            '',
            sep,
            '*ç”± AI æ•°å­—æº¯æºç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ*'
          ].join('\n');
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });