name: AI Digital Provenance (Full Repository & Simplified)

on:
  push:
    branches: [ main, develop ]
    # ç§»é™¤äº†ç‰¹å®šè·¯å¾„è¿‡æ»¤ï¼Œç°åœ¨ç›‘å¬é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å˜åŠ¨
    paths:
      - '**'
  pull_request:
    branches: [ main ]

jobs:
  ai-provenance:
    runs-on: ubuntu-latest

    steps:
    # 1. åŸºç¡€ç¯å¢ƒè®¾ç½®
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # 2. å®‰è£…æ ¸å¿ƒå·¥å…· (å·²ç§»é™¤ Cosign å®‰è£…æ­¥éª¤)
    - name: Install Syft (SBOM Generator)
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
        echo "ğŸ“¦ Syft installed for SBOM generation"

    # 3. AI æ•°å­—æº¯æºæ ¸å¿ƒæµç¨‹
    - name: Generate Base SBOM
      run: |
        echo "ğŸ“¦ Generating Software Bill of Materials..."
        # ä½¿ç”¨ Syft æ‰«æé¡¹ç›®å¹¶ç”ŸæˆåŸºç¡€ JSON æ¸…å•
        syft . -o cyclonedx-json > base-sbom.json
        COMPONENT_COUNT=$(jq '.components | length' base-sbom.json)
        echo "âœ… SBOM generated with $COMPONENT_COUNT components"
        echo "COMPONENT_COUNT=$COMPONENT_COUNT" >> $GITHUB_ENV

    - name: AI Code Detection & Full Range Statistics
      run: |
        echo "ğŸ¤– Running AI code detection and statistics in src/..."
        # è¿è¡Œ Python è„šæœ¬è¿›è¡Œå…¨åŸŸä»£ç è¡Œæ•°ç»Ÿè®¡ä¸ AI æ ‡è®°
        python3 scripts/process_aibom.py

        # ä½¿ç”¨ jq ä»ç”Ÿæˆçš„ aibom-final.json ä¸­æå–é‡åŒ–æŒ‡æ ‡
        AI_LINES=$(jq -r '.metadata.properties[] | select(.name=="stats:ai_total_lines") | .value' aibom-final.json)
        AI_PCT=$(jq -r '.metadata.properties[] | select(.name=="stats:ai_percentage") | .value' aibom-final.json)
        TOTAL_LINES=$(jq -r '.metadata.properties[] | select(.name=="stats:src_total_lines") | .value' aibom-final.json)

        echo "ğŸ” AI Statistics Results:"
        echo "  - Total Lines in src/: $TOTAL_LINES"
        echo "  - AI Generated Lines: $AI_LINES"
        echo "  - AI Percentage: $AI_PCT"

        # å°†ç»“æœå­˜å…¥ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "AI_LINES=$AI_LINES" >> $GITHUB_ENV
        echo "AI_PCT=$AI_PCT" >> $GITHUB_ENV
        echo "TOTAL_LINES=$TOTAL_LINES" >> $GITHUB_ENV

    # 4. ä¿å­˜ AI æº¯æºç»“æœ (ä»…ä¿ç•™æ ¸å¿ƒ AIBOMï¼Œç§»é™¤ç­¾åæ–‡ä»¶)
    - name: Upload AI Provenance Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ai-provenance-report-${{ github.sha }}
        path: aibom-final.json
        retention-days: 30

    # 5. åœ¨ GitHub Action ç•Œé¢ç”Ÿæˆå¯è§†åŒ–æ‘˜è¦
    - name: Generate AI Provenance Summary
      run: |
        echo "## ğŸ¤– AI æ•°å­—æº¯æºæŠ¥å‘Š (å…¨åŸŸç»Ÿè®¡)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š src/ ç›®å½•é‡åŒ–æŒ‡æ ‡" >> $GITHUB_STEP_SUMMARY
        echo "- **é¡¹ç›®æ€»è¡Œæ•°**: $TOTAL_LINES" >> $GITHUB_STEP_SUMMARY
        echo "- **AI ç”Ÿæˆè¡Œæ•°**: $AI_LINES" >> $GITHUB_STEP_SUMMARY
        echo "- **AI ä»£ç å æ¯”**: $AI_PCT" >> $GITHUB_STEP_SUMMARY
        echo "- **ä¾èµ–ç»„ä»¶æ€»æ•°**: $COMPONENT_COUNT" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "$AI_LINES" -ne "0" ]; then
          echo "âš ï¸ æ£€æµ‹åˆ° AI ç”Ÿæˆçš„ä»£ç ï¼Œå·²åœ¨ aibom-final.json ä¸­è‡ªåŠ¨æ ‡è®°" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… æœ¬æ¬¡æäº¤æœªæ£€æµ‹åˆ° AI æ ‡æ³¨çš„ä»£ç " >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*ğŸ¯ AI æ•°å­—æº¯æºç³»ç»Ÿ - ç¡®ä¿ä»£ç é€æ˜åº¦å’Œå¯è¿½æº¯æ€§*" >> $GITHUB_STEP_SUMMARY

    # 6. é’ˆå¯¹ Pull Request çš„ AI å˜æ›´åˆ†æ
    - name: Comment PR with AI Analysis
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const aiPct = process.env.AI_PCT;
          const aiLines = process.env.AI_LINES;
          const body = `## ğŸ¤– AI ä»£ç é€æ˜åº¦åˆ†æ\n\næœ¬æ¬¡å˜æ›´æ£€æµ‹åˆ° AI ä»£ç æ¸—é€ç‡ä¸º **${aiPct}** (å…± ${aiLines} è¡Œ)ã€‚\n\n---\n*ç”± AI æ•°å­—æº¯æºç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ*`;
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });