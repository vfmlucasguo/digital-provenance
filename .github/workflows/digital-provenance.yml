name: AI Digital Provenance (Simplified)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  ai-provenance:
    runs-on: ubuntu-latest

    steps:
    # 1. åŸºç¡€ç¯å¢ƒè®¾ç½®
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    # 2. å®‰è£…æ ¸å¿ƒå·¥å…· (ä»…AIæº¯æºå¿…éœ€)
    - name: Install Syft (SBOM Generator)
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
        echo "ğŸ“¦ Syft installed for SBOM generation"

    - name: Install Cosign (Digital Signing)
      uses: sigstore/cosign-installer@v3
      with:
        cosign-release: 'v2.2.0'

    # 3. AIæ•°å­—æº¯æºæ ¸å¿ƒæµç¨‹
    - name: Generate Base SBOM
      run: |
        echo "ğŸ“¦ Generating Software Bill of Materials..."
        syft . -o cyclonedx-json > base-sbom.json

        COMPONENT_COUNT=$(jq '.components | length' base-sbom.json)
        echo "âœ… SBOM generated with $COMPONENT_COUNT components"
        echo "COMPONENT_COUNT=$COMPONENT_COUNT" >> $GITHUB_ENV

    - name: AI Code Detection
      run: |
        echo "ğŸ¤– Running AI code detection..."
        python3 scripts/process_aibom.py

        AI_FILES=$(jq -r '.metadata.properties[] | select(.name=="ai:detected_files") | .value' aibom-final.json)
        AI_INDICATORS=$(jq -r '.metadata.properties[] | select(.name=="ai:detection_indicators") | .value' aibom-final.json)

        echo "ğŸ” AI Detection Results:"
        echo "  - AI Generated Files: $AI_FILES"
        echo "  - Detection Indicators: $AI_INDICATORS"

        echo "AI_FILES=$AI_FILES" >> $GITHUB_ENV
        echo "AI_INDICATORS=$AI_INDICATORS" >> $GITHUB_ENV

    - name: Setup Digital Signing
      env:
        COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
        COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
      run: |
        echo "ğŸ”‘ Setting up digital signing..."
        echo "$COSIGN_PRIVATE_KEY" > cosign.key
        chmod 600 cosign.key

    - name: Sign AI-Enhanced SBOM
      env:
        COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
      run: |
        echo "ğŸ” Signing AI-enhanced SBOM..."
        cosign sign-blob --key cosign.key --bundle aibom.sigstore.json aibom-final.json
        echo "âœ… Digital signature created"

    - name: Verify Digital Signature
      run: |
        echo "âœ… Verifying digital signature..."
        cosign verify-blob --key cosign.pub --bundle aibom.sigstore.json aibom-final.json
        echo "ğŸ¯ Signature verification successful"

    # 4. ä¿å­˜AIæº¯æºç»“æœ
    - name: Upload AI Provenance Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ai-provenance-${{ github.sha }}
        path: |
          base-sbom.json
          aibom-final.json
          aibom.sigstore.json
        retention-days: 90

    # 5. ç”ŸæˆAIæº¯æºæ‘˜è¦
    - name: Generate AI Provenance Summary
      run: |
        echo "## ğŸ¤– AIæ•°å­—æº¯æºæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š æ‰«æç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "- **æ€»ç»„ä»¶æ•°**: $COMPONENT_COUNT" >> $GITHUB_STEP_SUMMARY
        echo "- **AIç”Ÿæˆæ–‡ä»¶**: $AI_FILES ä¸ª" >> $GITHUB_STEP_SUMMARY
        echo "- **æ£€æµ‹æŒ‡æ ‡**: $AI_INDICATORS ä¸ª" >> $GITHUB_STEP_SUMMARY
        echo "- **æ•°å­—ç­¾å**: âœ… å·²éªŒè¯" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ” AIé€æ˜åº¦" >> $GITHUB_STEP_SUMMARY
        if [ "$AI_FILES" -gt "0" ]; then
          echo "âš ï¸ æ£€æµ‹åˆ°AIç”Ÿæˆçš„ä»£ç æ–‡ä»¶ï¼Œå·²è‡ªåŠ¨æ ‡è®°åœ¨SBOMä¸­" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… æœªæ£€æµ‹åˆ°AIç”Ÿæˆçš„ä»£ç æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“ æº¯æºæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "- åŸºç¡€SBOM: \`base-sbom.json\`" >> $GITHUB_STEP_SUMMARY
        echo "- AIå¢å¼ºSBOM: \`aibom-final.json\`" >> $GITHUB_STEP_SUMMARY
        echo "- æ•°å­—ç­¾å: \`aibom.sigstore.json\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*ğŸ¯ AIæ•°å­—æº¯æºç³»ç»Ÿ - ç¡®ä¿ä»£ç é€æ˜åº¦å’Œå¯è¿½æº¯æ€§*" >> $GITHUB_STEP_SUMMARY

    # 6. PRä¸­çš„AIå˜æ›´åˆ†æ (ä»…PRè§¦å‘)
    - name: AI Code Changes Analysis (PR only)
      if: github.event_name == 'pull_request'
      run: |
        echo "ğŸ” Analyzing AI code changes in this PR..."

        # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„AIç”Ÿæˆæ–‡ä»¶
        git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "(ai-gen|generated)" || echo "No AI-specific file changes detected"

        # ç®€å•çš„AIä»£ç å˜æ›´æç¤º
        if [ "$AI_FILES" -gt "0" ]; then
          echo "âš ï¸ This PR contains AI-generated code that has been automatically detected and marked in the SBOM" >> pr-comment.md
          echo "" >> pr-comment.md
          echo "**AI Transparency Report:**" >> pr-comment.md
          echo "- AI Generated Files: $AI_FILES" >> pr-comment.md
          echo "- Detection Confidence: High" >> pr-comment.md
          echo "- Digital Signature: âœ… Verified" >> pr-comment.md
        else
          echo "âœ… No AI-generated code detected in this PR" >> pr-comment.md
        fi

    - name: Comment PR with AI Analysis
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('pr-comment.md')) {
            const comment = fs.readFileSync('pr-comment.md', 'utf8');
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ¤– AIä»£ç é€æ˜åº¦åˆ†æ\n\n${comment}\n\n---\n*ç”±AIæ•°å­—æº¯æºç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ*`
            });
          }