#!/bin/bash

# Digital Provenance Pre-commit Hook
# This hook automatically generates SBOM, creates AIBOM, and signs it before each commit

echo "ğŸš€ Running Digital Provenance pre-commit checks..."

# Check if required tools are installed
command -v syft >/dev/null 2>&1 || { echo "âŒ Syft is not installed. Please install it first."; exit 1; }
command -v cosign >/dev/null 2>&1 || { echo "âŒ Cosign is not installed. Please install it first."; exit 1; }
command -v python3 >/dev/null 2>&1 || { echo "âŒ Python3 is not installed. Please install it first."; exit 1; }

# Generate base SBOM
echo "ğŸ“¦ Generating base SBOM..."
syft . -o cyclonedx-json > base-sbom.json
if [ $? -ne 0 ]; then
    echo "âŒ Failed to generate SBOM"
    exit 1
fi

# Process SBOM to create AIBOM
echo "ğŸ¤– Processing SBOM to AIBOM..."
python3 scripts/process_aibom.py
if [ $? -ne 0 ]; then
    echo "âŒ Failed to process AIBOM"
    exit 1
fi

# Sign AIBOM
echo "ğŸ”‘ Signing AIBOM..."
COSIGN_PASSWORD=12345678 cosign sign-blob --key cosign.key --bundle aibom.sigstore.json aibom-final.json
if [ $? -ne 0 ]; then
    echo "âŒ Failed to sign AIBOM"
    exit 1
fi

# Verify AIBOM
echo "âœ… Verifying AIBOM signature..."
cosign verify-blob --key cosign.pub --bundle aibom.sigstore.json aibom-final.json
if [ $? -ne 0 ]; then
    echo "âŒ Failed to verify AIBOM signature"
    exit 1
fi

echo "âœ… Digital Provenance checks completed successfully!"
echo "ğŸ“‹ AIBOM generated and signed: aibom-final.json"