#!/bin/bash

# Digital Provenance Pre-commit Hook - Optimized Version
# This hook automatically generates SBOM, creates AIBOM, and signs it before each commit

set -e  # Exit on any error

echo "ğŸš€ Running Digital Provenance pre-commit checks..."

# Load environment variables
if [ -f .env ]; then
    export $(cat .env | grep -v '^#' | xargs)
fi

# Check if required tools are installed
command -v syft >/dev/null 2>&1 || { echo "âŒ Syft is not installed. Please install it first."; exit 1; }
command -v cosign >/dev/null 2>&1 || { echo "âŒ Cosign is not installed. Please install it first."; exit 1; }
command -v python3 >/dev/null 2>&1 || { echo "âŒ Python3 is not installed. Please install it first."; exit 1; }

# Performance optimization: Check if package-lock.json changed
PACKAGE_LOCK_CHANGED=false
if git diff --cached --name-only | grep -q "package-lock.json"; then
    PACKAGE_LOCK_CHANGED=true
    echo "ğŸ“¦ Package dependencies changed, regenerating SBOM..."
elif [ ! -f "base-sbom.json" ]; then
    PACKAGE_LOCK_CHANGED=true
    echo "ğŸ“¦ No existing SBOM found, generating initial SBOM..."
else
    echo "ğŸ“¦ No dependency changes detected, using cached SBOM..."
fi

# Generate base SBOM only if needed
if [ "$PACKAGE_LOCK_CHANGED" = true ]; then
    echo "ğŸ“¦ Generating base SBOM..."
    syft . -o cyclonedx-json > base-sbom.json
    if [ $? -ne 0 ]; then
        echo "âŒ Failed to generate SBOM"
        exit 1
    fi
fi

# Process SBOM to create AIBOM
echo "ğŸ¤– Processing SBOM to AIBOM..."
python3 scripts/process_aibom.py
if [ $? -ne 0 ]; then
    echo "âŒ Failed to process AIBOM"
    exit 1
fi

# Security improvement: Use environment variable for password
if [ -z "$COSIGN_PASSWORD" ]; then
    echo "âŒ COSIGN_PASSWORD environment variable not set"
    echo "ğŸ’¡ Please set: export COSIGN_PASSWORD=your_secure_password"
    exit 1
fi

# Sign AIBOM
echo "ğŸ”‘ Signing AIBOM..."
cosign sign-blob --key cosign.key --bundle aibom.sigstore.json aibom-final.json
if [ $? -ne 0 ]; then
    echo "âŒ Failed to sign AIBOM"
    exit 1
fi

# Verify AIBOM
echo "âœ… Verifying AIBOM signature..."
cosign verify-blob --key cosign.pub --bundle aibom.sigstore.json aibom-final.json
if [ $? -ne 0 ]; then
    echo "âŒ Failed to verify AIBOM signature"
    exit 1
fi

# Optional: Run vulnerability scan if enabled
if [ "$ENABLE_VULN_SCAN" = "true" ]; then
    echo "ğŸ” Running vulnerability scan..."
    if command -v trivy >/dev/null 2>&1; then
        trivy sbom aibom-final.json --severity HIGH,CRITICAL --exit-code 1
        if [ $? -ne 0 ]; then
            echo "âš ï¸  High/Critical vulnerabilities found. Review before committing."
            # Don't exit here, just warn
        fi
    else
        echo "âš ï¸  Trivy not installed, skipping vulnerability scan"
    fi
fi

# Add provenance files to git
echo "ğŸ“ Adding provenance files to commit..."
git add base-sbom.json aibom-final.json aibom.sigstore.json

echo "âœ… Digital Provenance checks completed successfully!"
echo "ğŸ“‹ AIBOM generated and signed: aibom-final.json"
echo "â±ï¸  Workflow optimized for faster commits"